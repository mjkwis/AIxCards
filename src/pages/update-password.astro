---
/**
 * Update Password Page
 *
 * Page for setting a new password after clicking reset link
 * */

import PublicLayout from "@/layouts/PublicLayout.astro";
import { UpdatePasswordForm } from "@/components/auth/UpdatePasswordForm";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";

// DEV MODE: Show dev message
const isDev = import.meta.env.DEV;

// PRODUCTION: Check if user has valid session from reset link
let hasValidSession = false;
if (!isDev) {
  const {
    data: { session },
  } = await Astro.locals.supabase.auth.getSession();
  hasValidSession = !!session?.user;
}
---

<PublicLayout title="Ustaw nowe hasło - AIxCards" description="Ustaw nowe hasło do swojego konta AIxCards">
  <div class="container mx-auto px-4 py-16">
    <div class="max-w-md mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">Ustaw nowe hasło</h1>
        <p class="text-muted-foreground">Wybierz silne hasło dla swojego konta</p>
      </div>

      <div data-react-root>
        {
          (!isDev && !hasValidSession) ? (
            <Card>
              <CardContent class="py-8">
                <div class="text-center space-y-4">
                  <div class="mx-auto w-12 h-12 rounded-full bg-destructive/10 flex items-center justify-center">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="text-destructive"
                    >
                      <circle cx="12" cy="12" r="10" />
                      <line x1="12" y1="8" x2="12" y2="12" />
                      <line x1="12" y1="16" x2="12.01" y2="16" />
                    </svg>
                  </div>

                  <div>
                    <h3 class="font-semibold text-lg mb-2">Nieprawidłowy lub wygasły link</h3>
                    <p class="text-sm text-muted-foreground">
                      Link do resetowania hasła jest nieprawidłowy lub wygasł.
                    </p>
                    <p class="text-sm text-muted-foreground mt-2">
                      Poproś o nowy link resetujący, aby ustawić nowe hasło.
                    </p>
                  </div>

                  <div class="flex flex-col gap-2">
                    <Button onClick={() => (window.location.href = '/reset-password')}>Wyślij ponownie link</Button>
                    <Button variant="outline" onClick={() => (window.location.href = '/login')}>
                      Powrót do logowania
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ) : (
            <Card>
              <CardHeader>
                <CardTitle>Nowe hasło</CardTitle>
                <CardDescription>Wprowadź swoje nowe hasło</CardDescription>
              </CardHeader>
              <CardContent>
                <UpdatePasswordForm client:load />
              </CardContent>
            </Card>
          )
        }
      </div>
    </div>
  </div>
</PublicLayout>

